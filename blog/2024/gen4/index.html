<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="google-site-verification" content="fqpmQwGNtZ1kJ8UAsQMb7RD2N7DcYRDlyGbAJsnZuGM"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Generative Models 4 - Denoising Diffusion Probabilistic Models | Roy Friedman</title> <meta name="author" content="Roy Friedman"> <meta name="description" content=""> <meta name="keywords" content="academic-website, roy-friedman, machine-learning, ML, bayesian, PhD"> <meta name="google-site-verification" content="EUCyoY6MaSyn4ZvM9TfAuzzeleW7dR0PHS4_UCtyZ4I"> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="" id="highlight_theme_light"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://friedmanroy.github.io/blog/2024/gen4/"> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Generative Models 4 - Denoising Diffusion Probabilistic Models",
      "description": "",
      "published": "August 21, 2024",
      "authors": [
        {
          "author": "Roy Friedman",
          "authorURL": "",
          "affiliations": [
            {
              "name": "Hebrew University",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Roy </span>Friedman</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/BML/">Bayesian Machine Learning</a> </li> <li class="nav-item "> <a class="nav-link" href="/_pages/cv/">CV</a> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Generative Models 4 - Denoising Diffusion Probabilistic Models</h1> <p></p> </d-title> <d-byline></d-byline> <d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#the-setting">The Setting</a></div> <div><a href="#a-simple-variant-of-ddpm">A Simple Variant of DDPM</a></div> <div><a href="#ddpm-breakdown">DDPM Breakdown</a></div> <div><a href="#when-is-the-variational-bound-tight">When is the Variational Bound Tight?</a></div> <div><a href="#conclusion">Conclusion</a></div> </nav> </d-contents> <p><span style="float:left"><a href="https://friedmanroy.github.io/blog/2024/gen3/">← Normalizing Flows</a></span><span style="float:right"><a href="https://friedmanroy.github.io/blog/2024/gen5/">Score-Based Models →</a></span> <br></p> <d-byline></d-byline> <details><summary>Disclaimer</summary> <p>The math in the previous posts pretty much followed what you’d see in the literature, although there were small changes so it would be easier to understand. In the next two sections, however, the math and explanations are very different to what you would usually see.</p> <p>Why? Well, the explanations for both DDPM and score-based models are very involved, have a lot of disgusting math and are super hard to get, <em>intuitively</em>. My main goal was to help you <em>understand</em>, not just to copy down the equations you’d see in literature. So I followed the natural progression of the previous posts, which means that notations, steps and sometimes results are a bit different. Hopefully this enables you to go and learn on your own the exact details.</p> <p>Much of the following is a reframing of <d-cite key="luo2022understanding"></d-cite>, which deserves a lot of credit. There are particular parts I decided to expand into or cut out, but I generally followed their setup for DDPM. The parts regarding score-based models, though, are completely different and more fleshed out.</p> </details> <p>We can take what we saw before with VAEs and extend them. Instead of assuming that $z \mapsto x$ in one step, we will now assume that there are many steps from $z$ to $x$. We will define the steps intelligently so we know what happens from one point to the next, and then train something using ELBO to take us from one point to the next.</p> <p><br></p> <h1 id="the-setting"><strong>The Setting</strong></h1> <d-byline></d-byline> <p>Let’s suppose we have the following chain:</p> \[\begin{equation} x=x_{0}\rightarrow x_{1}\rightarrow\cdots\rightarrow x_{T-1}\rightarrow x_{T}=z \end{equation}\] <p>where <span>$x\sim p_{\text{data}}$</span> and $z\sim p_{T}\left(z\right)$, where $p_{T}\left(z\right)$ is many times just a Gaussian. Up until now we assumed that we have access to the mapping $z\mapsto x$ and had to “guess” or optimize the reverse mapping. This time, we’re gonna assume that we know how to turn $x$ into $z$, so we know $x\mapsto z$, and we want to find the opposite direction. This class of models is called <em>denoising diffusion probabilistic models</em> (DDPMs, <d-cite key="ho2020denoising"></d-cite>) for reasons that will become clear later on.</p> <p>Let’s call the noising direction the forward process, whose transition probabilities we will assume to be:</p> \[\begin{equation} q\left(x_{t}\vert x_{t-1}\right)=\mathcal{N}\left(x_{t}\vert \;\gamma_{t}x_{t-1},I\sigma_{t}^{2}\right) \end{equation}\] <p>where $\gamma_{t}$ is some constant and $\sigma_{t}^{2}$ is the variance of the noise added at step $t$. Both values are assumed to change as a function of the iteration. We want to learn a model of the reverse process, that is we want to learn $p_{\theta}\left(x_{t-1}\vert x_{t}\right)$. We’re going to guess that:</p> \[\begin{equation} q\left(x_{t-1}\vert x_{t}\right)\approx p_{\theta}\left(x_{t-1}\vert x_{t}\right)=\mathcal{N}\left(x_{t-1}\vert \;\mu_{\theta}\left(x_{t},t\right),I\sigma_{t-1}^{2}\right) \end{equation}\] <p>If this is how we model the “reverse process”, then sampling for this model will be quite easy: simply sample $x_{T}\sim p_{T}\left(z\right)$ and then use $p_{\theta}\left(x_{t-1}\vert x_{t}\right)$ to sample until you reach $x_{0}$. This is basically the following algorithm:</p> \[\begin{equation} x_{T}\sim p_{T}\left(z\right)\qquad\forall0\le t\le T-1:\;x_{t-1}=\mu_{\theta}\left(x_{t},t\right)+\sigma_{t-1}\epsilon\label{eq:DDPM-sampling} \end{equation}\] <p>where $\epsilon\sim\mathcal{N}\left(0,I\right)$.</p> <p>To train $p_{\theta}\left(x_{t-1}\vert x_{T}\right)$, what we want is high likelihood under “our guess”. The log-likelihood of an image, according to our model, is given by:</p> \[\begin{align} \log p_{\theta}\left(x_{0}\right) &amp; =\mathbb{E}_{p_{\theta}\left(x_{1},\cdots,x_{T}\right)}\left[\log p_{\theta}\left(x_{0},\cdots,x_{T}\right)\right] \end{align}\] <p>this will of course be quite hard to calculate, never mind optimize. Instead, we will use the same variational bound as we used for VAEs:</p> \[\begin{align} \log p_{\theta}\left(x_{0}\right) &amp; \ge\mathbb{E}_{q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)}\left[\log\frac{p_{\theta}\left(x_{0},\cdots,x_{T}\right)}{q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)}\right]\label{eq:DDPM-ELBO} \end{align}\] <details><summary>Scheduling choices</summary> <p>Because we kept everything abstract as possible so far, there is one thing that isn’t clear. How can we ensure the following:</p> \[\begin{equation} q\left(x_{T}\vert x_{0}\right)\overset{?}{=}p_{T}\left(z\right) \end{equation}\] <p>Notice that, as we defined it, the transition probability of the Markov chain $q\left(\cdot\vert \cdot\right)$ gives us the following:</p> \[\begin{equation} x_{t}=\gamma_{t}x_{t-1}+\sigma_{t}\epsilon_{t}\qquad\epsilon_{t}\sim\mathcal{N}\left(0,I\right) \end{equation}\] <p>and this can be opened up recursively:</p> \[\begin{align} x_{t} &amp; =\gamma_{t}\gamma_{t-1}x_{t-2}+\gamma_{t}\sigma_{t-1}\epsilon_{t-1}+\sigma_{t}\epsilon_{t}\\ \Rightarrow x_{t} &amp; =\gamma_{t}\gamma_{t-1}\gamma_{t-2}x_{t-3}+\gamma_{t}\gamma_{t-1}\sigma_{t-2}\epsilon_{t-2}+\gamma_{t}\sigma_{t-1}\epsilon_{t-1}+\sigma_{t}\epsilon_{t}\\ &amp; \vdots\\ \Rightarrow x_{t} &amp; =\left(\prod_{i=1}^{t}\gamma_{t}\right)x_{0}+\sum_{i=1}^{t}\prod_{j=i+1}^{t}\gamma_{j}\sigma_{i}\epsilon_{i}\label{eq:unrolled-DDPM-q} \end{align}\] <p>Let’s make our life slightly easier and call $\prod_{i}^{t}\gamma_{i}=\bar{\gamma}_{t}$ and $\bar{\sigma}_{t}^{2}=\sum_{i}^{t}\prod_{j=i+1}^{t}\gamma_{j}^{2}\sigma_{i}^{2}$. At any rate, $x_{t}$ is some vector dependent on $x_{0}$ plus a sum of Gaussians - the distribution $q\left(x_{t}\vert x_{0}\right)$ will also be a Gaussian:</p> \[\begin{equation} q\left(x_{t}\vert x_{0}\right)=\mathcal{N}\left(x_{t}\vert \;\bar{\gamma}_{t}x_{0},\;I\bar{\sigma}_{t}^{2}\right) \end{equation}\] <p>So if we want $q\left(x_{T}\vert x_{0}\right)=p_{T}\left(z\right)$ then we have to make sure that $p_{T}\left(z\right)$ is Gaussian and that for any $x_{0}$ we have:</p> \[\begin{equation} \mathbb{E}_{p_{T}}\left[z\right]=\bar{\gamma}_{T}x_{0} \end{equation}\] <p>and:</p> \[\begin{equation} \text{cov}_{p_{T}}\left[z\right]=I\bar{\sigma}_{T}^{2} \end{equation}\] <p>The most obvious choice is to use $p_{T}\left(z\right)=\mathcal{N}\left(z\vert 0,I\right)$, in which case we just need to ensure that $\bar{\gamma}_{T}\stackrel{T\rightarrow\infty}{\longrightarrow}0$ and $\bar{\sigma}_{T}\stackrel{T\rightarrow\infty}{\longrightarrow}1$.</p> </details> <p><br></p> <h1 id="a-simple-variant-of-ddpm"><strong>A Simple Variant of DDPM</strong></h1> <d-byline></d-byline> <p>There are two ways to proceed, simple or confusing. The confusing method is what (of course) is actually used, but we’ll start with the simple method.</p> <p>We’ll start by rewriting both $p_{\theta}\left(x_{0},\cdots,x_{T}\right)$ and $q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)$ into smaller factorizations. We can do this because both are Markov chains according to their construction, enabling us to rewrite them as:</p> \[\begin{align} p_{\theta}\left(x_{0},\cdots,x_{T}\right) &amp; =p_{\theta}\left(x_{0}\vert x_{1}\right)\cdot p_{\theta}\left(x_{1}\vert x_{2}\right)\cdots p_{\theta}\left(x_{T-1}\vert x_{T}\right)\cdot p_{\theta}\left(x_{T}\right)\\ q\left(x_{1},\cdots,x_{T}\vert x_{0}\right) &amp; =q\left(x_{1}\vert x_{0}\right)\cdot q\left(x_{2}\vert x_{1}\right)\cdots q\left(x_{T}\vert x_{T-1}\right) \end{align}\] <p>See how those line up nicely? Let’s put them back into equation \eqref{eq:DDPM-ELBO}:</p> \[\begin{align} \log p_{\theta}\left(x_{0}\right) &amp; \ge\mathbb{E}_{q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)}\left[\log p_{\theta}\left(x_{T}\right)+\sum_{t=1}^{T}\log p_{\theta}\left(x_{t}\vert x_{t+1}\right)-\sum_{t=1}^{T}\log q\left(x_{t}\vert x_{t-1}\right)\right]\\ &amp; =\mathbb{E}_{q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)}\left[\log p_{\theta}\left(x_{T}\right)+\log p_{\theta}\left(x_{0}\vert x_{1}\right)-\log q\left(x_{T}\vert x_{T-1}\right)\right.\\&amp;\qquad\qquad\qquad\qquad\left.+\sum_{t=1}^{T-1}\log\frac{p_{\theta}\left(x_{t}\vert x_{t+1}\right)}{q\left(x_{t}\vert x_{t-1}\right)}\right]\\ &amp; =\overbrace{\mathbb{E}_{q\left(x_{1}\vert x_{0}\right)}\left[\log p_{\theta}\left(x_{0}\vert x_{1}\right)\right]}^{\text{reconstruction term}}-\sum_{t=1}^{T-1}\mathbb{E}_{q\left(x_{t+1},x_{t-1}\vert x_{0}\right)}\overbrace{\left[D_{\text{KL}}\left(q\left(x_{t}\vert x_{t-1}\right)\,\vert \vert \,p_{\theta}\left(x_{t}\vert x_{t+1}\right)\right)\right]}^{\text{Markov chain term}}\\ &amp; \hfill\qquad\qquad\hfill\quad-\mathbb{E}_{q\left(x_{T-1}\vert x_{0}\right)}\underbrace{\left[D_{\text{KL}}\left(q\left(x_{T}\vert x_{T-1}\right)\,\vert \vert \,p_{\theta}\left(x_{T}\right)\right)\right]}_{\text{prior term}} \end{align}\] <p>We now have a lower bound on the log-likelihood. There are three terms of interest:</p> <ol> <li>The reconstruction term, which is basically the same as the reconstruction error we saw in the standard VAEs</li> <li>The KL-divergences inside the Markov chain term, which make up the bulk of the training in diffusion models. These KL terms try to ensure that if we go forward in the Markov chain, using $q\left(\cdot\vert \cdot\right)$ starting at $x_{0}$, or backward, using $p_{\theta}\left(\cdot\vert \cdot\right)$ starting at $x_{T}$, we’ll get the same distribution</li> <li>The prior term, which tries to make sure that are prior distribution in the latent space is correct. Notice that we assumed that $p_{\theta}\left(x_{T}\right)$ has a fixed distribution so there’s nothing to optimize here during training</li> </ol> <p>To optimize the lower bound, what we essentially need to do is make sure that for each $t$ the KL-divergence is low. Ignoring the reconstruction term for a moment, if we want to maximize the above lower bound, we just need to optimize the following loss:</p> \[\begin{equation} L\left(\theta\right)=\mathbb{E}_{t,x_{0},q\left(x_{t+1},x_{t-1}\vert x_{0}\right)}\left[D_{\text{KL}}\left(q\left(x_{t}\vert x_{t-1}\right)\,\vert \vert \,p_{\theta}\left(x_{t}\vert x_{t+1}\right)\right)\right] \end{equation}\] <p>Of course, we chose both $q\left(x_{t}\vert x_{t-1}\right)$ and $p_{\theta}\left(x_{t}\vert x_{t+1}\right)$ to be Gaussian distributions (with the same covariance even!), so we know what the KL-divergence equals:</p> \[\begin{equation} \Rightarrow L\left(\theta\right)=\mathbb{E}_{t,x_{0},q\left(x_{t+1},x_{t-1}\vert x_{0}\right)}\left[\frac{1}{\sigma_{t}}\| \mu_{\theta}\left(x_{t+1},t\right)-\gamma_{t}x_{t-1}\| ^{2}\right] \end{equation}\] <p>What a simple loss!</p> <p>So, why is this loss not usually used? The reason is that to calculate the loss at any point we need to make two MC estimates:</p> \[\begin{align} x_{t-1} &amp; \sim q\left(x_{t-1}\vert x_{0}\right)\\ x_{t+1} &amp; \sim q\left(x_{t+1}\vert x_{t-1}\right) \end{align}\] <p>The cited reason is then that this has more variance than the (soon to be seen) complex version.</p> <p>At any rate, the intuition for diffusion models is the same even in the complex setting.</p> <p><br></p> <h1 id="ddpm-breakdown"><strong>DDPM Breakdown</strong></h1> <d-byline></d-byline> <p>We are now going to break down $q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)$ in a strange way:</p> \[\begin{align} q\left(x_{1},\cdots,x_{T}\vert x_{0}\right) &amp; =q\left(x_{T}\vert x_{0}\right)q\left(x_{T-1}\vert x_{T},x_{0}\right)q\left(x_{T-2}\vert x_{T},x_{T-1},x_{0}\right)\cdots q\left(x_{1}\vert x_{T},\cdots,x_{2},x_{0}\right) \end{align}\] <p>Because of the fact that $q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)$ is a Markov chain, given both $x_{0}$ and $x_{t}$ is enough to completely describe $x_{t-1}$, so the above can be rewritten as:</p> \[\begin{equation} q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)=q\left(x_{T}\vert x_{0}\right)q\left(x_{T-1}\vert x_{T},x_{0}\right)\cdots q\left(x_{1}\vert x_{2},x_{0}\right) \end{equation}\] <p>Using this factorization, we now have:</p> \[\begin{align} \log p_{\theta}\left(x_{0}\right) &amp; \ge\mathbb{E}_{q\left(x_{1},\cdots,x_{T}\vert x_{0}\right)}\left[\log p_{\theta}\left(x_{0}\vert x_{1}\right)+\sum_{t=1}^{T}\frac{\log p_{\theta}\left(x_{t-1}\vert x_{t}\right)}{\log q\left(x_{t-1}\vert x_{t},x_{0}\right)}+\log\frac{p_{\theta}\left(x_{T}\right)}{q\left(x_{T}\vert x_{0}\right)}\right]\\ &amp; =\mathbb{E}_{q\left(x_{1}\vert x_{0}\right)}\left[\log p_{\theta}\left(x_{0}\vert x_{1}\right)\right]-\sum_{t=1}^{T}\mathbb{E}_{q\left(x_{t}\vert x_{0}\right)}\left[D_{\text{KL}}\left(q\left(x_{t-1}\vert x_{t},x_{0}\right)\vert \vert p_{\theta}\left(x_{t-1},x_{t}\right)\right)\right]-D_{\text{KL}}\left(q\left(x_{T}\vert x_{0}\right)\vert \vert p_{\theta}\left(x_{T}\right)\right) \end{align}\] <p>For now, let’s ignore that first term. Notice that in the last term we have nothing to optimize, so even if we train a model we won’t have to take it into account. We’ll now divert our attention to the middle expression which is the bulk of the lower bound.</p> <h3 id="the-really-nasty-part">The Really Nasty Part</h3> <p>As we saw from the breakdown that led to equation \eqref{eq:unrolled-DDPM-q}, because of our choice for the forward process, $q\left(x_{t}\vert x_{0}\right)$ is a Gaussian whose mean and covariance we know explicitly. This is, first of all, good to know… but we want $q\left(x_{t-1}\vert x_{t},x_{0}\right)$. Using Bayes’ law:</p> \[\begin{equation} q\left(x_{t-1}\vert x_{t},x_{0}\right)\propto q\left(x_{t}\vert x_{t-1}\right)q\left(x_{t-1}\vert x_{0}\right) \end{equation}\] <p>Basically, $q\left(x_{t-1}\vert x_{t},x_{0}\right)$ is the multiplication of two Gaussian distributions (which are linear in $x_{t-1}$), which means that it will also be Gaussian.</p> <p>After massaging this expression for a while, you’ll find out that:</p> \[\begin{equation} q\left(x_{t-1}\vert x_{t},x_{0}\right)=\mathcal{N}\left(x_{t-1}\vert \;a_{t}x_{0}+b_{t}x_{t},\;I\kappa_{t}^{2}\right) \end{equation}\] <p>where $a_{t}$, $b_{t}$ and $\kappa_{t}$ are some constants that depend on $t$ which don’t really matter for now. You can look below for their exact values, but the bottom line is that $q\left(x_{t-1}\vert x_{t},x_{0}\right)$ is also Gaussian and we can find an analytical expression for it.</p> <details><summary>Finding the Gaussian</summary> <p>Given $x_{0}$, $x_{t}$ and $x_{t-1}$ are jointly Gaussian:</p> \[\begin{equation} p\left(x_{t},x_{t-1}\vert x_{0}\right)=\mathcal{N}\left(\left(\begin{matrix}x_{t}\\ x_{t-1} \end{matrix}\right)\vert \quad\left(\begin{matrix}\bar{\gamma}_{t}x_{0}\\ \bar{\gamma}_{t-1}x_{0} \end{matrix}\right),\Sigma\right) \end{equation}\] <p>with:</p> \[\begin{equation} \Sigma=\left(\begin{matrix}I\bar{\sigma}_{t}^{2} &amp; I\sigma_{t}^{2}\\ I\sigma_{t}^{2} &amp; I\bar{\sigma}_{t-1}^{2} \end{matrix}\right) \end{equation}\] <p>Using identities for conditionals of jointly Gaussian distributions<d-footnote>See my <a href="https://friedmanroy.github.io/BML/3_gaussians">BML notes for this</a></d-footnote>, we have:</p> \[\begin{align} \mathbb{E}\left[x_{t-1}\vert x_{t},x_{0}\right] &amp; =\bar{\gamma}_{t-1}x_{0}+\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t}^{2}}\left(x_{t}-\bar{\gamma}_{t}x_{0}\right)\\ &amp; =\left(\bar{\gamma}_{t-1}-\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t}^{2}}\bar{\gamma}_{t}\right)x_{0}+\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t}^{2}}x_{t}\\ \text{cov}\left[x_{t-1}\vert x_{t},x_{0}\right] &amp; =I\left(\bar{\sigma}_{t-1}^{2}-\frac{\sigma_{t}^{4}}{\bar{\sigma}_{t}^{2}}\right)=I\left(\bar{\sigma}_{t-1}^{2}-\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t-1}^{2}}\right) \end{align}\] <p>Define:</p> \[\begin{align} a_{t} &amp; =\bar{\gamma}_{t-1}-\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t}^{2}}\bar{\gamma}_{t}\\ b_{t} &amp; =\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t}^{2}}\\ \kappa_{t}^{2} &amp; =\bar{\sigma}_{t-1}^{2}-\frac{\sigma_{t}^{2}}{\bar{\sigma}_{t-1}^{2}} \end{align}\] <p>Then: \(\begin{equation} q\left(x_{t-1}\vert x_{t},x_{0}\right)=\mathcal{N}\left(x_{t-1}\vert \;a_{t}x_{0}+b_{t}x_{t},\;I\kappa_{t}^{2}\right) \end{equation}\)</p> </details> <h3 id="the-training-loss-finally">The Training Loss, Finally</h3> <p>Remember, what we wanted was to find the terms $D\left(q\left(x_{t-1}\vert x_{t},x_{0}\right)\vert \vert p_{\theta}\left(x_{t-1}\vert x_{t}\right)\right)$. We now have all we need to actually state what the loss at time point $t$ is actually equal to, since the KL-divergence between two Gaussians has a closed-form equation. The KL divergence between Gaussians is given by:</p> \[\begin{align} D_{\text{KL}}\left(\mathcal{N}\left(x\vert \mu_{x},\Sigma_{x}\right)\vert \vert \mathcal{N}\left(y\vert \mu_{y},\Sigma_{y}\right)\right)&amp;=\frac{1}{2}\left[\log\left\vert \Sigma_{y}\Sigma_{x}^{-1}\right\vert +\text{trace}\left(\Sigma_{y}^{-1}\Sigma_{x}\right)+\right. \\ &amp;\left.\left(\mu_{y}-\mu_{x}\right)^{T}\Sigma_{y}^{-1}\left(\mu_{y}-\mu_{x}\right)-\text{dim}\left(x\right)\right] \end{align}\] <p>In our setting, the covariances aren’t learnable parameters, and the dimension is constant, so we can just ignore everything that doesn’t correspond to the means. Our training loss is then:</p> \[\begin{equation} L\left(\theta\right)=\mathbb{E}_{x_{0},\,t,\,q\left(x_{t}\vert x_{0}\right)}\left[\frac{1}{\kappa_{t}^{2}}\| \mu_{\theta}\left(x_{t},t\right)-a_{t}x_{0}-b_{t}x_{t}\| ^{2}\right] \end{equation}\] <p>Notice that as we defined it, our model $\mu_{\theta}\left(x_{t},t\right)$ already depends on $x_{t}$. We can maybe improve our model a bit by making sure that it learns something that takes this information into account. If we choose:</p> \[\begin{equation} \mu_{\theta}\left(x_{t},t\right)=a_{t}s_{\theta}\left(x_{t},t\right)+b_{t}x_{t} \end{equation}\] <p>then we can get rid of one of the terms in the loss to get:</p> \[\begin{equation} L\left(\theta\right)=\mathbb{E}_{x_{0},\,t,\,q\left(x_{t}\vert x_{0}\right)}\left[\frac{a_{t}^{2}}{\kappa_{t}^{2}}\| s_{\theta}\left(x_{t},t\right)-x_{0}\| ^{2}\right] \end{equation}\] <p>This, finally, explains the name “<em>denoising</em> diffusion” - all we want from our model is to denoise the inputs! Given a point $x_{t}$, our model basically tries to guess what $x_{0}$ was, and the loss is weighted by the variance we expect to see.</p> <p><br></p> <h1 id="when-is-the-variational-bound-tight"><strong>When is the Variational Bound Tight?</strong></h1> <d-byline></d-byline> <p>When we talked about VAEs, we said that the ELBO is tight when:</p> \[\begin{equation} q_{\phi}\left(z\vert x\right)=p_{\theta}\left(z\vert x\right) \end{equation}\] <p>Exactly the same considerations are true for diffusion models, where the ELBO is tight when:</p> \[\begin{equation} \forall t\quad p_{\theta}\left(x_{t-1}\vert x_{t}\right)=q\left(x_{t-1}\vert x_{t}\right) \end{equation}\] <p>But, unlike VAEs, choosing $p_{\theta}\left(x_{t-1}\vert x_{t}\right)$ as a Gaussian distribution is much more principled. It can be shown (I’ll give a semblance of a proof in the next post) that if we have enough steps with small enough differences between them (i.e. $\sigma_{t}\rightarrow0$) in the forward process, then the reverse process will also be a Markov chain with Gaussian transitions. In other words, if we design the forward process to have enough steps with small enough variances, then our modeling for the reverse process is correct.</p> <p><br></p> <h1 id="conclusion"><strong>Conclusion</strong></h1> <d-byline></d-byline> <p>The original DDPM paper <d-cite key="ho2020denoising"></d-cite> made quite a splash, since training it was much simpler than GANs (more on them later on) but the sample quality was very good. These results, paired with the simple denoising loss we found, were a big surprise, and consequently there was (and still is, at the time of writing) <em>a lot</em> of research into diffusion models.</p> <p>Still the naive DDPM (as described here) is still a bit lacking as a generative model. This is mainly due to the fact that every operation (whether generation or inference) requires iterating over the whole Markov chain, which can be quite slow. As described here, getting good results requires Markov chains with around 1000 steps, which is like denoising 1000 images <em>sequentially</em>. The next post will focus on a way to generalize DDPMs into score-based generative models, which will ultimately enable faster sampling and easier control over design choices. <br></p> <d-byline></d-byline> <p><span style="float:left"><a href="https://friedmanroy.github.io/blog/2024/gen3/">← Normalizing Flows</a></span><span style="float:right"><a href="https://friedmanroy.github.io/blog/2024/gen5/">Score-Based Models →</a></span></p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/primer_generative_biblio.bib"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2025 Roy Friedman. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener noopener noreferrer" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener noopener noreferrer">GitHub Pages</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script async src="https://www.googletagmanager.com/gtag/js?id=G-1B05NVC2PJ"></script> <script>function gtag(){window.dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-1B05NVC2PJ");</script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>